---
import { getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import Chip from '../../../components/Chip.astro';
import Footer from '../../../components/Footer.astro';
import GlowButton from '../../../components/GlowButton.astro';
import Header from '../../../components/Header.astro';
import { getHtmlLang, type LocaleCode } from '../../../i18n/config';
import { themeConfig } from '../../../theme.config';
import { groupPostsByTag } from '../../../utils/tags';
import { routes } from '../../../utils/routes';

const locale: LocaleCode = 'en';
const htmlLang = getHtmlLang(locale);
const currentPath = Astro.url?.pathname ?? '/';
const currentSearch = Astro.url?.search ?? '';
const localePosts = (await getCollection('blog')).filter((post) => post.data.lang === locale);
const tagMap = groupPostsByTag(localePosts);
const tags = Array.from(tagMap.entries()).map(([slug, group]) => ({
	slug,
	label: group.label,
	count: group.posts.length,
	feedHref: routes.tagFeed(slug, locale),
}));

tags.sort((a, b) => (b.count - a.count) || a.label.localeCompare(b.label, htmlLang));
const homeHref = routes.home(locale);
const blogHref = routes.blog(locale);
---

<!doctype html>
<html lang={htmlLang}>
	<head>
		<BaseHead title={`Tags | ${themeConfig.site.title}`} description={themeConfig.site.description} />
	</head>

	<body>
		<Header locale={locale} pathname={currentPath} search={currentSearch} />
		<main class="page-shell tags-shell">
				<section class="tags-header">
					<h1>
						<span class="display-special primary">Tag</span> map
					</h1>
					<p>
						Drill down by topic and jump straight to playlists, AppSec notes, and homelab experiments. Each tag exposes its
						own feed so you can subscribe only to the themes you care about.
					</p>
					<div class="tags-header__actions">
						<GlowButton href={homeHref} variant="ghost" size="sm">‚Üê Back to home</GlowButton>
						<GlowButton href={blogHref} variant="ghost" size="sm">Full blog</GlowButton>
					</div>
				</section>

			{tags.length ? (
				<section>
					<ul class="tags-grid">
						{tags.map((tag) => (
								<li class="tags-grid__item" aria-label={`Tag ${tag.label}`}>
									<a href={tag.feedHref} class="tags-grid__link">
										<Chip>{tag.label}</Chip>
								<span class="tags-grid__count">
									{tag.count} {tag.count === 1 ? 'article' : 'articles'}
								</span>
									</a>
								</li>
							))}
					</ul>
				</section>
			) : (
				<p class="tags-empty text-muted">No tags available yet.</p>
			)}
		</main>
		<Footer locale={locale} />
	</body>
</html>

<style>
	.tags-shell {
		padding-top: 4rem;
		padding-bottom: 3rem;
	}

	.tags-header {
		max-width: 720px;
		margin: 0 auto 3rem;
		text-align: center;
		display: flex;
		flex-direction: column;
		gap: 1rem;
		align-items: center;
	}

	.tags-header__actions {
		display: flex;
		gap: 0.75rem;
		flex-wrap: wrap;
		justify-content: center;
	}

	.tags-grid {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		list-style: none;
		padding: 0;
		justify-content: center;
	}

	.tags-grid__item {
		margin: 0;
	}

	.tags-grid__link {
		display: inline-flex;
		flex-direction: column;
		align-items: center;
		gap: 0.35rem;
		text-decoration: none;
		color: inherit;
		padding: 0.25rem 0.75rem;
	}

	.tags-grid__count {
		font-size: 0.9rem;
		color: var(--color-muted);
		text-transform: uppercase;
		letter-spacing: 0.2em;
	}

	.tags-empty {
		text-align: center;
		margin-top: 2rem;
	}
</style>
